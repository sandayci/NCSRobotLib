<!DOCTYPE html>
<html lang="en">
<head>
 <meta charset=utf-8 http-equiv="Content-Language" content="en"/>
 <title>WebAEX test app</title>
 <link rel="stylesheet" type="text/css" href="main.css">
 <script src="browserdetect.js"></script>
 <script src="aeplot.js"></script>
 <script src="biasctl.js"></script>
 <script src="experiments.js"></script>
</head>

<body>
<header></header>
<article>

<section class="log">
&gt; Welcome to WebAEX! <br />
&gt; Detected browser: <span id="brow">...</span><br />
&gt; System status: <span id="wsdi_status">Not initialized</span>
</section>

<section id="aer">
<div id="grid0" class="grid"></div>
<div id="raster0" class="raster"></div>
<div id="ctl">
    Received event: <span id="raw_event"> </span><br />
    <input type=button id="button_reset" value="Reset Buffer" />
    <input type=button id="button_pause" value="Pause Stream" />
    <input type=button id="button_save" value="Save Experiment" />
</div>
</section>

<section id="params">
<div class="tabs">
    <div id="biases_set">
        <a href="#">Set Biases</a>
        <div></div>
    </div>
    <div id="biases_load">
        <a href="#">Load Biases</a>
        <div></div>
    </div>
    <div id="experiment">
        <a href="#">Load Experiment</a>
        <div></div>
    </div>
</div>
</section>

</article>

<script>
//detect browser
document.getElementById("brow").textContent = " " + BrowserDetect.browser + " "
        + BrowserDetect.version +" " + BrowserDetect.OS +" ";

//hex to dec
function h2d(h) {
	return parseInt(h,16);
} 

//tabbing
function switchTab(a) {
    var tabs = a.parentNode.parentNode.children;
    for (var i = 0; i < tabs.length; i++ ) {
    	tabs[i].className = 'hidden';
    }
    a.parentNode.className = 'selected';
}

function init_tabbing() {
//must be called after bias menu has been created!
    var alltabs = document.getElementsByClassName('tabs');
    for (var i = 0; i < alltabs.length; i++) {
        //walk through menus
	var tabs = alltabs[i].children;
        for (var j = 0; j < tabs.length; j++) {
            //walk through individual tabs
            var a = tabs[j].getElementsByTagName('a')[0];
            a.addEventListener("click", function(){ switchTab(this); });
        }
    }
}

//dumb aer protocol
function get_appropriate_ws_url()
{
	var pcol;
	var u = document.URL;
	pcol = "ws://";
	if (u.substring(0, 4) == "http")
		u = u.substr(7);
	u = u.split('/');
	/* + "/xxx" bit is for IE10 workaround */
	return pcol + u[0] + "/xxx";
}

experimentsInit();
//gridInit();
rasterInit();

var socket_di;
var el_wsdi_status = document.getElementById("wsdi_status");
var el_raw_event = document.getElementById("raw_event");
var el_button_pause = document.getElementById("button_pause");
var el_button_reset = document.getElementById("button_reset");
var el_button_save = document.getElementById("button_save");
//var el_button_connect_tsp = document.getElementById("button_connect_tsp");
//var el_button_sample_tsp = document.getElementById("button_sample_tsp");
//var el_button_stream_tsp = document.getElementById("button_stream_tsp");

document.getElementById("raw_event").textContent = get_appropriate_ws_url();

if (typeof MozWebSocket != "undefined") {
	socket_di = new MozWebSocket(get_appropriate_ws_url(),
			   "dumb-aer-protocol");
} else {
	socket_di = new WebSocket(get_appropriate_ws_url(),
			   "dumb-aer-protocol");
}

try {
	socket_di.onopen = function() {
		el_wsdi_status.style.backgroundColor = "#ee3";
		el_wsdi_status.textContent = "websocket connection opened";
		el_button_pause.disabled = false;
	} 
	socket_di.onmessage = function got_packet(msg) {
		var events = msg.data.slice(0,-1).split(";");
		plotUpdate(events);
		expUpdate(events);
	} 
	socket_di.onclose = function(){
		el_wsdi_status.style.backgroundColor = "#ff4040";
		el_wsdi_status.textContent = "websocket connection CLOSED";
	}
}
catch(exception) {
	alert('Error' + exception);  
}

//stream control
function resetStream() {
	var RPCStr = jsonRPCStr("resetBuffer");
	socket_di.send(RPCStr);
	el_button_pause.disabled = false;
}
function pauseStream() {
	var RPCStr = jsonRPCStr("pauseStream");
	el_button_pause.disabled = true;
	socket_di.send(RPCStr);
}
el_button_reset.addEventListener("click", resetStream);
el_button_pause.addEventListener("click", pauseStream);
el_button_save.addEventListener("click", saveExperiment);
//el_button_connect_tsp.addEventListener("click", connectTSP);
//el_button_sample_tsp.addEventListener("click", plotNextSample);
//el_button_stream_tsp.addEventListener("click", autoPlotSample);

</script>

</body>
</html>
